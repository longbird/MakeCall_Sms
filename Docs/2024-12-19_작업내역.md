# AutoCallSmsApp 작업 내역 (2024-12-19)

## 개요
이 문서는 2024년 12월 19일에 수행된 AutoCallSmsApp 개발 작업을 단계별로 정리한 것입니다.

---

## 1. 스피커/마이크 끄기 기능 추가

### 목적
통화 중 스피커와 마이크를 자동으로 끄는 기능을 추가하여, 자동 전화 시 불필요한 소리 출력과 마이크 입력을 방지합니다.

### 변경 파일

#### 1.1 AndroidManifest.xml
- `MODIFY_AUDIO_SETTINGS` 권한 추가
```xml
<!-- 오디오 설정 권한 (스피커/마이크 제어) -->
<uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
```

#### 1.2 activity_main.xml
- 시작 버튼 위에 체크박스 2개 추가
- 스피커 끄기 체크박스 (기본값: 체크됨)
- 마이크 끄기 체크박스 (기본값: 체크됨)

```xml
<!-- 스피커/마이크 설정 체크박스 -->
<LinearLayout
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="horizontal"
    android:layout_marginBottom="8dp">

    <CheckBox
        android:id="@+id/cbMuteSpeaker"
        android:layout_width="0dp"
        android:layout_height="wrap_content"
        android:layout_weight="1"
        android:text="스피커 끄기"
        android:checked="true"
        android:textSize="14sp" />

    <CheckBox
        android:id="@+id/cbMuteMic"
        android:layout_width="0dp"
        android:layout_height="wrap_content"
        android:layout_weight="1"
        android:text="마이크 끄기"
        android:checked="true"
        android:textSize="14sp" />
</LinearLayout>
```

#### 1.3 MainActivity.kt
- `CheckBox` import 추가
- companion object에 정적 변수 추가:
  - `isSpeakerMuted: Boolean` - 스피커 끄기 상태
  - `isMicMuted: Boolean` - 마이크 끄기 상태
- 체크박스 변수 선언 및 초기화
- 체크박스 상태 변경 리스너 설정

```kotlin
// companion object에 추가
var isSpeakerMuted = true
var isMicMuted = true

// 체크박스 리스너
cbMuteSpeaker.setOnCheckedChangeListener { _, isChecked ->
    isSpeakerMuted = isChecked
}
cbMuteMic.setOnCheckedChangeListener { _, isChecked ->
    isMicMuted = isChecked
}
```

#### 1.4 PhoneStateReceiver.kt
- `AudioManager` import 추가
- 오디오 상태 저장 변수 추가 (복원용):
  - `previousSpeakerphoneOn: Boolean?`
  - `previousMicMute: Boolean?`
- `applyAudioSettings()` 함수 추가: 통화 연결 시 오디오 설정 적용
- `restoreAudioSettings()` 함수 추가: 통화 종료 시 원래 상태로 복원

### 동작 방식
1. 앱 실행 시 기본적으로 두 체크박스가 체크됨
2. 전화 연결 시(OFFHOOK) 현재 오디오 상태 저장 후 설정 적용
3. 통화 종료 시(IDLE) 저장된 이전 상태로 자동 복원
4. 체크 해제 시 해당 기능 미적용

### 커밋
```
[master ea25f26] 통화 중 스피커/마이크 끄기 기능 추가
```

---

## 2. 서버 주소 자동 저장/로드 기능 추가

### 목적
서버 접속에 성공한 주소를 로컬에 저장하여, 다음 앱 실행 시 자동으로 해당 주소가 설정되도록 합니다.

### 변경 파일

#### 2.1 MainActivity.kt
- SharedPreferences 관련 상수 추가:
  - `PREF_NAME = "AutoCallSettings"`
  - `KEY_SERVER_ADDRESS = "server_address"`
  - `DEFAULT_SERVER_ADDRESS = "192.168.0.210:8080"`

- `saveServerAddress()` 함수 추가: 서버 주소 저장
- `loadServerAddress()` 함수 추가: 저장된 주소 로드

```kotlin
private fun saveServerAddress(address: String) {
    val prefs = getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
    prefs.edit().putString(KEY_SERVER_ADDRESS, address).apply()
}

private fun loadServerAddress(): String {
    val prefs = getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
    return prefs.getString(KEY_SERVER_ADDRESS, DEFAULT_SERVER_ADDRESS) ?: DEFAULT_SERVER_ADDRESS
}
```

- `onCreate()`에서 저장된 서버 주소 로드
- `fetchMorePhoneNumbers()`의 `onSuccess` 콜백에서 서버 주소 저장

### 동작 방식
1. 앱 첫 실행 → 기본값 `192.168.0.210:8080` 표시
2. 다른 주소 입력 후 서버 접속 성공 → 해당 주소 저장
3. 앱 재실행 → 마지막 성공한 주소 자동 로드

### 커밋
```
[master 0dcbbcb] 서버 주소 자동 저장/로드 기능 추가
```

---

## 3. 빌드 환경 설정

### 문제점
WSL 환경에서 Windows용 Android SDK를 사용할 수 없음 (빌드 도구가 .exe 파일)

### 해결 방법
홈 디렉토리에 설치된 Linux용 Android SDK 사용

#### 3.1 local.properties 수정
```properties
sdk.dir=/home/longbird/android-sdk
```

### 빌드 명령어
```bash
# 디버그 APK 빌드
./gradlew assembleDebug

# 릴리즈 APK 빌드
./gradlew assembleRelease
```

### SDK 구성
- build-tools: 34.0.0, 35.0.0
- platforms: android-34
- cmdline-tools, platform-tools 포함

---

## 4. 앱 아이콘 변경 (Adaptive Icon)

### 문제점
기존 `mipmap-xxhdpi/ic_launcher.png` 파일이 JPEG 형식이었으나 PNG 확장자로 되어있어 빌드 실패

### 해결 방법
Vector drawable 기반 Adaptive Icon으로 교체

### 변경 파일

#### 4.1 삭제된 파일
- `app/src/main/res/mipmap-xxhdpi/ic_launcher.png` (잘못된 JPEG 파일)

#### 4.2 추가된 파일

**drawable/ic_launcher_background.xml**
```xml
<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="108dp"
    android:height="108dp"
    android:viewportWidth="108"
    android:viewportHeight="108">
    <path
        android:fillColor="#4CAF50"
        android:pathData="M0,0h108v108h-108z"/>
</vector>
```

**drawable/ic_launcher_foreground.xml**
- 흰색 전화 아이콘 (Material Design 스타일)

**mipmap-anydpi-v26/ic_launcher.xml**
```xml
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@drawable/ic_launcher_background"/>
    <foreground android:drawable="@drawable/ic_launcher_foreground"/>
</adaptive-icon>
```

### 결과
- 녹색 배경에 흰색 전화 아이콘
- Android 8.0 (API 26) 이상에서 Adaptive Icon 지원

### 커밋
```
[master 9a149d0] 앱 아이콘을 adaptive icon으로 변경
```

---

## 5. 배포용 APK 빌드

### 빌드 과정
1. `./gradlew assembleRelease` 실행
2. 생성된 unsigned APK를 debug 키로 서명

### 서명 명령어
```bash
APKSIGNER=~/android-sdk/build-tools/35.0.0/apksigner
ZIPALIGN=~/android-sdk/build-tools/35.0.0/zipalign

$ZIPALIGN -v -p 4 app-release-unsigned.apk app-release-unsigned.apk.aligned
$APKSIGNER sign --ks ~/.android/debug.keystore --ks-pass pass:android \
    --key-pass pass:android --out app-release.apk app-release-unsigned.apk.aligned
```

### 생성된 APK
- 경로: `app/build/outputs/apk/release/app-release.apk`
- 크기: 약 5.1MB
- 서명: Debug 키 (테스트/개발 배포용)

---

## 커밋 히스토리

| 커밋 해시 | 메시지 |
|-----------|--------|
| ea25f26 | 통화 중 스피커/마이크 끄기 기능 추가 |
| 0dcbbcb | 서버 주소 자동 저장/로드 기능 추가 |
| 9a149d0 | 앱 아이콘을 adaptive icon으로 변경 |

---

## 참고사항

### 권한 목록
| 권한 | 용도 |
|------|------|
| CALL_PHONE | 전화 걸기 |
| READ_PHONE_STATE | 통화 상태 모니터링 |
| RECEIVE_SMS / READ_SMS | SMS 수신 및 읽기 |
| ANSWER_PHONE_CALLS | 자동 전화 끊기 |
| MODIFY_AUDIO_SETTINGS | 스피커/마이크 제어 |
| INTERNET | REST API 통신 |

### 테스트 환경
- Android SDK: API 34
- Build Tools: 35.0.0
- Kotlin: 1.9.20
- Gradle: 8.13
